package me.moomoo.anarchyexploitfixes;

import com.github.retrooper.packetevents.PacketEvents;
import io.github.retrooper.packetevents.factory.spigot.SpigotPacketEventsBuilder;
import io.papermc.lib.PaperLib;
import me.moomoo.anarchyexploitfixes.commands.AEFCommand;
import me.moomoo.anarchyexploitfixes.config.Config;
import me.moomoo.anarchyexploitfixes.config.Datastore;
import me.moomoo.anarchyexploitfixes.config.LanguageCache;
import me.moomoo.anarchyexploitfixes.listener.AEFListener;
import me.moomoo.anarchyexploitfixes.modules.AEFModule;
import me.moomoo.anarchyexploitfixes.utils.CachingPermTool;
import me.moomoo.anarchyexploitfixes.utils.models.TPSCache;
import org.apache.logging.log4j.Level;
import org.apache.logging.log4j.core.config.Configurator;
import org.bstats.bukkit.Metrics;
import org.bukkit.command.CommandSender;
import org.bukkit.entity.Player;
import org.bukkit.plugin.java.JavaPlugin;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.File;
import java.nio.file.Files;
import java.util.*;
import java.util.jar.JarFile;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

public class AnarchyExploitFixes extends JavaPlugin {

    private static AnarchyExploitFixes instance;
    private static Map<String, LanguageCache> languageCacheMap;
    private static Config config;
    private static Datastore datastore;
    private static TPSCache tpsCache;
    private static CachingPermTool cachingPermTool;
    private static Logger prefixedLogger, unPrefixedLogger;
    private static Metrics metrics;

    @Override
    public void onLoad() {
        // Disable logging for some shaded libraries as those can get very verbose
        Configurator.setLevel("me.moomoo.anarchyexploitfixes.libs.reflections.Reflections", Level.OFF);
        Configurator.setLevel("me.moomoo.anarchyexploitfixes.libs.zaxxer.hikari.pool.PoolBase", Level.OFF);
        Configurator.setLevel("me.moomoo.anarchyexploitfixes.libs.zaxxer.hikari.pool.HikariPool", Level.OFF);
        Configurator.setLevel("me.moomoo.anarchyexploitfixes.libs.zaxxer.hikari.HikariDataSource", Level.OFF);
        Configurator.setLevel("me.moomoo.anarchyexploitfixes.libs.zaxxer.hikari.HikariConfig", Level.OFF);
        Configurator.setLevel("me.moomoo.anarchyexploitfixes.libs.zaxxer.hikari.util.DriverDataSource", Level.OFF);
        PacketEvents.setAPI(SpigotPacketEventsBuilder.build(this));
        PacketEvents.getAPI().getSettings().reEncodeByDefault(false).checkForUpdates(false).bStats(false);
        PacketEvents.getAPI().load();
    }

    @Override
    public void onEnable() {
        instance = this;
        prefixedLogger = LoggerFactory.getLogger(getLogger().getName());
        unPrefixedLogger = LoggerFactory.getLogger("");
        cachingPermTool = CachingPermTool.enable(this);
        metrics = new Metrics(this, 8700);

        prefixedLogger.info("                                                          ");
        prefixedLogger.info("                                                          ");
        prefixedLogger.info("     █████  ███████ ███████                               ");
        prefixedLogger.info("    ██   ██ ██      ██             AnarchyExploitFixes    ");
        prefixedLogger.info("    ███████ █████   █████            Made by moom0o       ");
        prefixedLogger.info("    ██   ██ ██      ██             Rewritten by xGinko    ");
        prefixedLogger.info("    ██   ██ ███████ ██                                    ");
        prefixedLogger.info("                                                          ");
        prefixedLogger.info("                                                          ");

        if (!PaperLib.isPaper()) {
            prefixedLogger.error("This plugin depends on Paper's API, which is not present on your server.");
            PaperLib.suggestPaper(this, java.util.logging.Level.SEVERE);
            getServer().getPluginManager().disablePlugin(this);
            return;
        }

        prefixedLogger.info("Detected Version 1." + PaperLib.getMinecraftVersion() + "." + PaperLib.getMinecraftPatchVersion());

        if (PaperLib.getMinecraftVersion() < 12) {
            prefixedLogger.warn("This version is unsupported. Expect issues.");
        } else if (PaperLib.getMinecraftVersion() >= 20) {
            prefixedLogger.warn("Legacy is intended for Paper server versions 1.12 - 1.19.4.");
            prefixedLogger.warn("The plugin will perform better if you use the Folia jar for your server.");
        }

        try {
            getDataFolder().mkdirs();
        } catch (Exception e) {
            prefixedLogger.trace("Failed to create plugin folder!", e);
            getServer().getPluginManager().disablePlugin(this);
        }

        prefixedLogger.info("Loading Datastore");
        datastore = new Datastore();

        prefixedLogger.info("Loading Translations");
        reloadLang();

        prefixedLogger.info("Loading Modules");
        reloadConfiguration();

        prefixedLogger.info("Registering Commands");
        AEFCommand.registerCommands();

        prefixedLogger.info("Initializing PacketEvents");
        PacketEvents.getAPI().init();

        prefixedLogger.info("Ready.");
    }

    @Override
    public void onDisable() {
        AEFModule.disableAll();
        AEFListener.enabledListeners.forEach(AEFListener::disable);
        PacketEvents.getAPI().terminate();
        if (metrics != null) {
            metrics.shutdown();
            metrics = null;
        }
        if (cachingPermTool != null) {
            cachingPermTool.shutdown();
            cachingPermTool = null;
        }
        instance = null;
        config = null;
        languageCacheMap = null;
        tpsCache = null;
        prefixedLogger = null;
    }

    public static AnarchyExploitFixes getInstance()  {
        return instance;
    }
    public static Config getConfiguration() {
        return config;
    }
    public static Datastore getDatastore() {
        return datastore;
    }
    public static TPSCache getTPSCache() {
        return tpsCache;
    }
    public static Logger getPrefixedLogger() {
        return prefixedLogger;
    }
    public static Logger getUnprefixedLogger() {
        return unPrefixedLogger;
    }
    public static LanguageCache getLang(Locale locale) {
        return getLang(locale.toString().toLowerCase());
    }
    public static LanguageCache getLang(CommandSender commandSender) {
        return commandSender instanceof Player ? getLang(((Player) commandSender).getLocale()) : getLang(config.default_lang);
    }
    public static LanguageCache getLang(String lang) {
        if (!config.auto_lang) return languageCacheMap.get(config.default_lang.toString().toLowerCase());
        return languageCacheMap.getOrDefault(lang.replace("-", "_"), languageCacheMap.get(config.default_lang.toString().toLowerCase()));
    }

    public void reloadPlugin() {
        reloadLang();
        reloadConfiguration();
    }

    private void reloadConfiguration() {
        try {
            config = new Config();
            tpsCache = TPSCache.create(config.tps_cache_duration);
            AEFListener.reloadListeners();
            AEFModule.reloadModules();
            config.saveConfig();
        } catch (Exception e) {
            prefixedLogger.error("Failed to load config file!", e);
        }
    }

    public void reloadLang() {
        languageCacheMap = new HashMap<>();
        try {
            File langDirectory = new File(getDataFolder() + "/lang");
            Files.createDirectories(langDirectory.toPath());
            Set<String> locales = new HashSet<>();
            locales.addAll(getDefaultLocales(getFile()));
            locales.addAll(getPresentLocales(langDirectory));
            StringBuilder stringBuilder = new StringBuilder();
            int i = 0;
            for (String localeString : locales) {
                stringBuilder.append(localeString);
                i++;
                if (i < 4) {
                    stringBuilder.append(", ");
                } else {
                    prefixedLogger.info(stringBuilder.toString());
                    stringBuilder = new StringBuilder();
                    i = 0;
                }
                languageCacheMap.put(localeString, new LanguageCache(localeString));
            }
        } catch (Throwable t) {
            prefixedLogger.error("Error loading language files!", t);
        }
    }

    private static final Pattern langPattern = Pattern.compile("([a-z]{1,3}_[a-z]{1,3})(\\.yml)", Pattern.CASE_INSENSITIVE);

    private Set<String> getDefaultLocales(File jarFile) {
        try (final JarFile pluginJarFile = new JarFile(jarFile)) {
            return pluginJarFile.stream()
                    .map(zipEntry -> {
                        Matcher matcher = langPattern.matcher(zipEntry.getName());
                        return matcher.find() ? matcher.group(1) : null;
                    })
                    .filter(Objects::nonNull)
                    .collect(Collectors.toSet());
        } catch (Throwable t) {
            prefixedLogger.error("Failed getting default lang files!", t);
            return Collections.emptySet();
        }
    }

    private Set<String> getPresentLocales(File folder) {
        try {
            return Arrays.stream(Objects.requireNonNull(folder.listFiles()))
                    .map(file -> {
                        Matcher matcher = langPattern.matcher(file.getName());
                        return matcher.find() ? matcher.group(1) : null;
                    })
                    .filter(Objects::nonNull)
                    .collect(Collectors.toSet());
        } catch (Throwable t) {
            prefixedLogger.error("Failed getting lang files from plugin folder!", t);
            return Collections.emptySet();
        }
    }
}
