package me.moomoo.anarchyexploitfixes.modules.preventions;

import com.cryptomorin.xseries.XMaterial;
import me.moomoo.anarchyexploitfixes.AnarchyExploitFixes;
import me.moomoo.anarchyexploitfixes.config.Config;
import me.moomoo.anarchyexploitfixes.modules.AnarchyExploitFixesModule;
import org.bukkit.ChatColor;
import org.bukkit.Material;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.block.Action;
import org.bukkit.event.player.PlayerInteractEvent;
import org.bukkit.event.player.PlayerQuitEvent;
import org.bukkit.inventory.ItemStack;

import java.time.Duration;
import java.util.HashMap;
import java.util.UUID;

public class MapSpam implements AnarchyExploitFixesModule, Listener {

    private final HashMap<UUID, Integer> mapCount = new HashMap<>();
    private final HashMap<UUID, Long> cooldowns = new HashMap<>();
    private final Material map;

    private final boolean shouldNotifyPlayers;
    private final long cooldownInMillis;
    private final int mapCreateLimit;
    
    public MapSpam() {
        shouldEnable();
        Config config = AnarchyExploitFixes.getConfiguration();
        config.addComment("preventions.prevent-map-reset-spam.enable", "Puts a cooldown on creating maps so players cant reset map arts that easily\nOnly really needed on versions below 1.13");
        this.shouldNotifyPlayers = config.getBoolean("preventions.prevent-map-reset-spam.notify-players", true, "Sends a message to players telling them how many maps they can create per time");
        this.cooldownInMillis = config.getInt("preventions.prevent-map-reset-spam.cooldown-time-in-minutes", 60) * 60000L;
        this.mapCreateLimit = config.getInt("preventions.prevent-map-reset-spam.max-amount-of-maps-per-time", 4);
        this.map = XMaterial.MAP.parseMaterial();
    }

    @Override
    public String name() {
        return "prevent-map-reset-spam";
    }

    @Override
    public String category() {
        return "preventions";
    }

    @Override
    public void enable() {
        AnarchyExploitFixes plugin = AnarchyExploitFixes.getInstance();
        plugin.getServer().getPluginManager().registerEvents(this, plugin);
    }

    @Override
    public boolean shouldEnable() {
        return AnarchyExploitFixes.getConfiguration().getBoolean("preventions.prevent-map-reset-spam.enable", false);
    }

    @EventHandler(priority = EventPriority.NORMAL)
    private void onMapCreate(PlayerInteractEvent event) {
        Action action = event.getAction();
        if (action.equals(Action.LEFT_CLICK_AIR) || action.equals(Action.LEFT_CLICK_BLOCK)) return;
        
        ItemStack mapItem = event.getItem();
        if (mapItem == null || !mapItem.getType().equals(map)) return;

        Player player = event.getPlayer();
        if (player.hasPermission("anarchyexploitfixes.mapspambypass")) return;

        final UUID playerUniqueId = player.getUniqueId();
        final long currentTime = System.currentTimeMillis();

        if (!mapCount.containsKey(playerUniqueId) || !cooldowns.containsKey(playerUniqueId)) {
            mapCount.put(playerUniqueId, 1);
            cooldowns.put(playerUniqueId, currentTime);
            if (shouldNotifyPlayers) player.sendMessage(
                    AnarchyExploitFixes.getLang(player.getLocale()).mapspam_youCanOnlyCreateXMoreMaps
                            .replace("%amount%", String.valueOf(mapCreateLimit-1))
                            .replace("%time%", formatToHoursAndMinutes(cooldownInMillis))
                    );
            return;
        }

        int mapsCreatedCount = mapCount.get(playerUniqueId);
        final long millisBetweenFirstMapCreateAndNow = currentTime - cooldowns.get(playerUniqueId);

        if (mapsCreatedCount >= mapCreateLimit) {
            if (millisBetweenFirstMapCreateAndNow < cooldownInMillis) {
                event.setCancelled(true);
                player.updateInventory();
                if (shouldNotifyPlayers) player.sendMessage(
                        AnarchyExploitFixes.getLang(player.getLocale()).mapspam_exceededLimit
                                .replace("%time%", formatToHoursAndMinutes(cooldownInMillis - millisBetweenFirstMapCreateAndNow))
                        );
                return;
            }

            // Reset
            mapsCreatedCount = 1;
        }

        mapsCreatedCount++;

        if (shouldNotifyPlayers) {
            int remaining = mapCreateLimit - mapsCreatedCount;
            if (remaining > 0) player.sendMessage(
                    AnarchyExploitFixes.getLang(player.getLocale()).mapspam_youCanOnlyCreateXMoreMaps
                            .replace("%amount%", String.valueOf(remaining))
                            .replace("%time%", formatToHoursAndMinutes(cooldownInMillis - millisBetweenFirstMapCreateAndNow))
            );
        }

        mapCount.put(playerUniqueId, mapsCreatedCount);
        cooldowns.put(playerUniqueId, currentTime);
    }

    @EventHandler(priority = EventPriority.NORMAL, ignoreCancelled = true)
    private void onPlayerQuit(PlayerQuitEvent event) {
        UUID playerUniqueId = event.getPlayer().getUniqueId();
        cooldowns.remove(playerUniqueId);
        mapCount.remove(playerUniqueId);
    }

    private static String formatToHoursAndMinutes(long millis) {
        Duration duration = Duration.ofMillis(millis);
        if (duration.toHours() <= 0) return String.format("%02dm", (int) duration.toMinutes() % 60);
        return String.format("%02dh %02dm", duration.toHours(), (int) duration.toMinutes() % 60);
    }
}
