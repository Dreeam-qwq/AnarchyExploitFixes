package me.moomoo.anarchyexploitfixes.modules.illegals.items;

import com.destroystokyo.paper.event.player.PlayerArmorChangeEvent;
import me.moomoo.anarchyexploitfixes.enums.AEFPermission;
import me.moomoo.anarchyexploitfixes.enums.ItemLegality;
import me.moomoo.anarchyexploitfixes.events.PacketPlayerAttackEntityEvent;
import me.moomoo.anarchyexploitfixes.events.PacketPlayerUseItemEvent;
import me.moomoo.anarchyexploitfixes.modules.AEFModule;
import me.moomoo.anarchyexploitfixes.utils.CachingPermTool;
import org.bukkit.entity.EntityType;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.block.BlockDispenseEvent;
import org.bukkit.event.entity.EntityDamageByEntityEvent;
import org.bukkit.event.inventory.InventoryClickEvent;
import org.bukkit.event.inventory.InventoryMoveItemEvent;
import org.bukkit.event.player.PlayerAttemptPickupItemEvent;
import org.bukkit.event.player.PlayerDropItemEvent;
import org.bukkit.event.player.PlayerInteractEntityEvent;
import org.bukkit.event.player.PlayerInteractEvent;
import org.bukkit.inventory.ItemStack;

public interface IllegalItemModule extends AEFModule, Listener {

    AEFPermission bypassPermission();
    ItemLegality legalityOf(ItemStack itemStack);
    void handleItem(ItemStack itemStack, ItemLegality legality);

    default ItemLegality legalityOf(Iterable<ItemStack> itemStacks) {
        if (itemStacks == null) {
            return ItemLegality.LEGAL;
        }

        for (ItemStack itemStack : itemStacks) {
            if (legalityOf(itemStack) != ItemLegality.LEGAL) {
                return ItemLegality.CONTAINS_ILLEGAL;
            }
        }

        return ItemLegality.LEGAL;
    }

    default Listener getHopperListener() {
        return new Listener() {
            @EventHandler(priority = EventPriority.HIGHEST, ignoreCancelled = true)
            private void onItemGoesThroughHopper(InventoryMoveItemEvent event) {
                if (legalityOf(event.getItem()) != ItemLegality.LEGAL) {
                    event.setCancelled(true);
                }
            }
        };
    }

    @EventHandler(priority = EventPriority.HIGHEST, ignoreCancelled = true)
    default void onAttack(PacketPlayerAttackEntityEvent event) {
        final Player player = event.getPlayer();
        if (player == null) return;
        ItemStack itemStack = player.getInventory().getItem(event.getHand());
        final ItemLegality legality = legalityOf(itemStack);
        if (legality != ItemLegality.LEGAL && !CachingPermTool.hasPermission(bypassPermission(), player)) {
            event.setCancelled(true);
            handleItem(itemStack, legality);
        }
    }

    @EventHandler(priority = EventPriority.HIGHEST, ignoreCancelled = true)
    default void onUseItem(PacketPlayerUseItemEvent event) {
        final Player player = event.getPlayer();
        if (player == null) return;
        ItemStack itemStack = player.getInventory().getItem(event.getHand());
        final ItemLegality legality = legalityOf(itemStack);
        if (legality != ItemLegality.LEGAL && !CachingPermTool.hasPermission(bypassPermission(), player)) {
            event.setCancelled(true);
            handleItem(itemStack, legality);
        }
    }

    @EventHandler(priority = EventPriority.HIGHEST, ignoreCancelled = true)
    default void onAttack(EntityDamageByEntityEvent event) {
        if (event.getDamager().getType() != EntityType.PLAYER) return;

        final Player player = (Player) event.getDamager();

        ItemStack mainHandItem = player.getInventory().getItemInMainHand();
        final ItemLegality mainHandLegality = legalityOf(mainHandItem);
        if (mainHandLegality != ItemLegality.LEGAL && !CachingPermTool.hasPermission(bypassPermission(), player)) {
            event.setCancelled(true);
            handleItem(mainHandItem, mainHandLegality);
        }

        ItemStack offHandItem = player.getInventory().getItemInOffHand();
        final ItemLegality offHandLegality = legalityOf(offHandItem);
        if (offHandLegality != ItemLegality.LEGAL && !CachingPermTool.hasPermission(bypassPermission(), player)) {
            event.setCancelled(true);
            handleItem(offHandItem, offHandLegality);
        }
    }

    @EventHandler(priority = EventPriority.HIGHEST, ignoreCancelled = true)
    default void onDispense(BlockDispenseEvent event) {
        if (legalityOf(event.getItem()) != ItemLegality.LEGAL) {
            event.setCancelled(true);
        }
    }

    @EventHandler(priority = EventPriority.HIGHEST, ignoreCancelled = true)
    default void onArmorChange(PlayerArmorChangeEvent event) {
        if (CachingPermTool.hasPermission(bypassPermission(), event.getPlayer())) return;
        handleItem(event.getNewItem(), legalityOf(event.getNewItem()));
        handleItem(event.getOldItem(), legalityOf(event.getOldItem()));
    }

    @EventHandler(priority = EventPriority.HIGHEST, ignoreCancelled = true)
    default void onInventoryClick(InventoryClickEvent event) {
        if (event.getClick().isCreativeAction()) return;
        if (CachingPermTool.hasPermission(bypassPermission(), event.getWhoClicked())) return;

        handleItem(event.getCurrentItem(), legalityOf(event.getCurrentItem()));
        handleItem(event.getCursor(), legalityOf(event.getCursor()));
        for (ItemStack invItem : event.getWhoClicked().getInventory()) {
            handleItem(invItem, legalityOf(invItem));
        }
    }

    @EventHandler(priority = EventPriority.HIGHEST, ignoreCancelled = true)
    default void onPlayerPickupItem(PlayerAttemptPickupItemEvent event) {
        ItemStack pickUpItem = event.getItem().getItemStack();
        final ItemLegality legality = legalityOf(pickUpItem);
        if (legality != ItemLegality.LEGAL && !CachingPermTool.hasPermission(bypassPermission(), event.getPlayer())) {
            event.setCancelled(true);
            handleItem(pickUpItem, legality);
            event.getItem().setItemStack(pickUpItem);
        }
    }

    @EventHandler(priority = EventPriority.HIGHEST, ignoreCancelled = true)
    default void onPlayerDropItem(PlayerDropItemEvent event) {
        ItemStack droppedItem = event.getItemDrop().getItemStack();
        final ItemLegality legality = legalityOf(droppedItem);
        if (legality != ItemLegality.LEGAL && !CachingPermTool.hasPermission(bypassPermission(), event.getPlayer())) {
            handleItem(droppedItem, legality);
            event.getItemDrop().setItemStack(droppedItem);
        }
    }

    @EventHandler(priority = EventPriority.HIGHEST, ignoreCancelled = false)
    default void onInteract(PlayerInteractEvent event) {
        ItemStack interactItem = event.getItem();
        final ItemLegality legality = legalityOf(interactItem);
        if (legality != ItemLegality.LEGAL && !CachingPermTool.hasPermission(bypassPermission(), event.getPlayer())) {
            event.setCancelled(true);
            handleItem(interactItem, legality);
        }
    }

    @EventHandler(priority = EventPriority.HIGHEST, ignoreCancelled = true)
    default void onInteractEntity(PlayerInteractEntityEvent event) {
        ItemStack handItem = event.getPlayer().getInventory().getItem(event.getHand());
        final ItemLegality legality = legalityOf(handItem);
        if (legality != ItemLegality.LEGAL && !CachingPermTool.hasPermission(bypassPermission(), event.getPlayer())) {
            event.setCancelled(true);
            handleItem(handItem, legality);
        }
    }
}
